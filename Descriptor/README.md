# 描述符

[描述符](https://docs.python.org/zh-cn/3/howto/descriptor.html)的主要作用：控制通过.进行变量查找时发生的事。描述符必须作为类属性来使用。

## 原理

默认的属性查找是从对象的字典开始的，然后是对象类型的字典，之后是父类的字典。实现描述符协议可覆盖默认行为。

1. 仅定义`__get__`为非数据描述符。与实例字典同名时，实例字典的条目优先，
2. 定义`__set__`或`__delete__`为数据描述符。与实例字典同名时，数据描述符优先。
3. 只读数据需定义`__get__`和`__set__`，在`__set__`中抛出异常。

描述符的调用过程：

- 从实例调用`a.x`：查找顺序为数据描述符->实例变量->非数据描述符->类变量->`__getattr__`。找到描述符后调用`desc.__get__(a, type(a))`。注意`.`的逻辑在`__getattribute__`里实现。
- 从类调用`A.x`: 和实例调用类似，只是没有实例变量查找。找到后调用`desc.__get__(None, A)`。
- 从`super`调用`super(A, obj).m`: 根据MRO算法的第一个基类`B`返回`B.__dict__['m'].__get__(obj, A)`。

描述符的调用机制嵌入在`__getattribute__`里，重写此方法可能会阻止描述符的自动调用。

有时候描述符想知道描述符在哪个类被使用，以及被分配的变量名，描述符需要定义`__set_name__`方法。

## 应用

1. `classmethod()`, `staticmethod()`, `property()`
2. 数据校验类
3. ORM



